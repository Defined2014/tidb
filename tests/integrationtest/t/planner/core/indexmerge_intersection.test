# TestSPMForIntersectionIndexMerge
drop table if exists t;
create table t(a int, b int, c int, d int, e int, index ia(a), index ib(b), index ic(c), index id(d), index ie(e));
explain select * from t where a = 10 and b = 20 and c > 30 and d is null and e in (0, 100);
explain select /*+ use_index_merge(t, ia, ib, ic, id, ie) */ * from t where a = 10 and b = 20 and c > 30 and d is null and e in (0, 100);

create global binding for
	select * from t where a = 10 and b = 20 and c > 30 and d is null and e in (0, 100)
using
	select /*+ use_index_merge(t, ia, ib, ic, id, ie) */ * from t where a = 10 and b = 20 and c > 30 and d is null and e in (0, 100);
explain select * from t where a = 10 and b = 20 and c > 30 and d is null and e in (0, 100);

drop global binding for select * from t where a = 10 and b = 20 and c > 30 and d is null and e in (0, 100);


# TestHintForIntersectionIndexMerge
drop table if exists t, t1, t2, t3, t4, t5, t6, t7, t8;
drop view if exists v, v1, vh;
create table t1(a int, b int, c int, d int, e int, index ia(a), index ibc(b, c),index ic(c), index id(d), index ie(e))partition by range(c) (partition p0 values less than (10),partition p1 values less than (20),partition p2 values less than (30),partition p3 values less than (maxvalue));
insert into t1 values (10, 20, 5, 5, 3), (20, 20, 50, 5, 200), (20, 20, 10, 5, 5), (10, 30, 5, 3, 1);
create definer='root'@'localhost' view vh as select /*+ use_index_merge(t1, ia, ibc, id) */ * from t1 where a = 10 and b = 20 and c < 30 and d in (2,5);
create definer='root'@'localhost' view v as select * from t1 where a = 10 and b = 20 and c < 30 and d in (2,5);
create definer='root'@'localhost' view v1 as select * from t1 where a = 10 and b = 20;
create table t2(a int, b int, c int, d int, e int, index ia(a), index ibc(b, c), index id(d), index ie(e))partition by range columns (c, d) (partition p0 values less than (10, 20),partition p1 values less than (30, 40),partition p2 values less than (50, 60),partition p3 values less than (maxvalue, maxvalue));
insert into t2 values (10, 20, 5, 5, 3), (20, 20, 20, 5, 100), (100, 30, 5, 3, 100);
create table t3(a int, b int, c int, d int, e int, index ia(a), index ibc(b, c), index id(d), index ie(e))partition by hash (e) partitions 5;
insert into t3 values (10, 20, 5, 5, 3), (20, 20, 20, 5, 100), (10, 30, 5, 3, 100);
create table t4(a int, b int, c int, d int, e int, index ia(a), index ibc(b, c), index id(d), index ie(e))partition by list (d) (partition p0 values in (1,2,3,4,5),partition p1 values in (6,7,8,9,10),partition p2 values in (11,12,13,14,15),partition p3 values in (16,17,18,19,20));
insert into t4 values (30, 20, 5, 8, 100), (20, 20, 20, 3, 2), (10, 30, 5, 3, 100);
create table t5(s1 varchar(20) collate utf8mb4_bin,s2 varchar(30) collate ascii_bin,s3 varchar(50) collate utf8_unicode_ci,s4 varchar(20) collate gbk_chinese_ci,index is1(s1), index is2(s2), index is3(s3), index is4(s4));
insert into t5 values ('Abc', 'zzzz', 'aa', 'ccc'), ('abc', 'zzzz', 'CCC', 'ccc');
create table t6(s1 varchar(20) collate utf8mb4_bin,s2 varchar(30) collate ascii_bin,s3 varchar(50) collate utf8_unicode_ci,s4 varchar(20) collate gbk_chinese_ci,primary key (s1, s2(10)) nonclustered,index is1(s1), index is2(s2), index is3(s3), index is4(s4));
insert into t6 values ('Abc', 'zzzz', 'A啊A', 'Cdaa'), ('Abc', 'zczz', 'A啊', 'Cda');
create table t7(a tinyint unsigned,b bit(3),c float,d decimal(10,3),e datetime,f timestamp(5),g year,primary key (d) nonclustered,index ia(a), unique index ib(b), index ic(c), index ie(e), index iff(f), index ig(g));
insert into t7 values (100, 6, 12.2, 56, '2022-11-22 17:00', '2022-12-21 00:00', 2021),(20, 7, 12.4, 30, '2022-12-22 17:00', '2016-12-21 00:00', 2021);
create table t8(s1 mediumtext collate utf8mb4_general_ci,s2 varbinary(20),s3 tinyblob,s4 enum('测试', 'aA', '??') collate gbk_chinese_ci,s5 set('^^^', 'tEsT', '2') collate utf8_general_ci,primary key (s1(10)) nonclustered,unique index is2(s2(20)), index is3(s3(20)), index is4(s4), index is5(s5));
insert into t8 values('啊aabbccdd', 'abcc', 'cccc', 'aa', '2,test'),('啊aabb', 'abcdc', 'aaaa', '??', '2');
set @@tidb_partition_prune_mode = 'dynamic';
analyze table t1,t2,t3,t4;

--enable_warnings
set @@tidb_partition_prune_mode = 'dynamic';
explain format = 'brief' select * from vh;
--sorted_result
select * from vh;
explain format = 'brief' select /*+ qb_name(v, v), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ qb_name(v, v@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ qb_name(v, v@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ qb_name(v, v1@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v1 where c < 30 and d in (2,5);
--sorted_result
select /*+ qb_name(v, v1@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v1 where c < 30 and d in (2,5);
explain format = 'brief' select /*+ use_index_merge(t2, ia, ibc, id, ie) */ * from t2 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
--sorted_result
select /*+ use_index_merge(t2, ia, ibc, id, ie) */ * from t2 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
explain format = 'brief' select /*+ use_index_merge(t3, ia, ibc, id, ie) */ * from t3 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
--sorted_result
select /*+ use_index_merge(t3, ia, ibc, id, ie) */ * from t3 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
explain format = 'brief' select /*+ use_index_merge(t4, ia, ibc, id, ie) */ * from t4 where a > 10 and b = 20 and c < 35 and d in (1,3,8,9) and e = 100;
--sorted_result
select /*+ use_index_merge(t4, ia, ibc, id, ie) */ * from t4 where a > 10 and b = 20 and c < 35 and d in (1,3,8,9) and e = 100;
explain format = 'brief' select /*+ use_index_merge(t5, is1, is2, is3, is4) */ * from t5 where s1 = 'Abc' and s2 > 'zzz' and s3 < 'B啊a' and s4 = 'CcC';
--sorted_result
select /*+ use_index_merge(t5, is1, is2, is3, is4) */ * from t5 where s1 = 'Abc' and s2 > 'zzz' and s3 < 'B啊a' and s4 = 'CcC';
explain format = 'brief' select /*+ use_index_merge(t6, primary, is3, is4) */ * from t6 where s1 = 'Abc' and s2 > 'zzz' and s3 = 'A啊a' and s4 not like 'Cd_';
--sorted_result
select /*+ use_index_merge(t6, primary, is3, is4) */ * from t6 where s1 = 'Abc' and s2 > 'zzz' and s3 = 'A啊a' and s4 not like 'Cd_';
explain format = 'brief' select /*+ use_index_merge(t7, primary,ia,ib,ic,ie,iff,ig) */ * from t7 where a = 100 and b > 5 and c < 12.3 and d > 54.321 and e = '2022-11-22 17:00' and f > '2020-6-23 10:00' and g < 2025;
--sorted_result
select /*+ use_index_merge(t7, primary,ia,ib,ic,ie,iff,ig) */ * from t7 where a = 100 and b > 5 and c < 12.3 and d > 54.321 and e = '2022-11-22 17:00' and f > '2020-6-23 10:00' and g < 2025;
explain format = 'brief' select /*+ use_index_merge(t8, primary,is2,is3,is4,is5) */ * from t8 where s1 like '啊A%' and s2 > 'abc' and s3 > 'cba' and s4 in ('aA', '??') and s5 = 'test,2';
--sorted_result
select /*+ use_index_merge(t8, primary,is2,is3,is4,is5) */ * from t8 where s1 like '啊A%' and s2 > 'abc' and s3 > 'cba' and s4 in ('aA', '??') and s5 = 'test,2';
explain format = 'brief' select (select /*+ use_index_merge(t1,ia,ibc,ic) */ a from t1 where t1.a > 10 and t1.b = 20 and t1.c = t2.a) from t2;
--sorted_result
select (select /*+ use_index_merge(t1,ia,ibc,ic) */ a from t1 where t1.a > 10 and t1.b = 20 and t1.c = t2.a) from t2;
explain format = 'brief' select (select /*+ use_index_merge(t1,ia,ibc,ic) */ a from t1 where t1.a > 10 and t1.b = 20 and t1.c > t2.a) from t2;
--sorted_result
select (select /*+ use_index_merge(t1,ia,ibc,ic) */ a from t1 where t1.a > 10 and t1.b = 20 and t1.c > t2.a) from t2;
explain format = 'brief' select (select /*+ use_index_merge(t1,ia,ibc,ic) */ a from t1 where t1.a > 10 and t1.b = 20 and t1.e > t2.a) from t2;
--sorted_result
select (select /*+ use_index_merge(t1,ia,ibc,ic) */ a from t1 where t1.a > 10 and t1.b = 20 and t1.e > t2.a) from t2;
set @@tidb_partition_prune_mode = 'static';
explain format = 'brief' select * from vh;
--sorted_result
select * from vh;
explain format = 'brief' select /*+ qb_name(v, v), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ qb_name(v, v@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ qb_name(v, v@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ qb_name(v, v@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
--sorted_result
select /*+ qb_name(v, v@sel_1 .@sel_1), use_index_merge(@v t1, ia, ibc, id) */ * from v;
explain format = 'brief' select /*+ use_index_merge(t2, ia, ibc, id, ie) */ * from t2 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
--sorted_result
select /*+ use_index_merge(t2, ia, ibc, id, ie) */ * from t2 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
explain format = 'brief' select /*+ use_index_merge(t3, ia, ibc, id, ie) */ * from t3 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
--sorted_result
select /*+ use_index_merge(t3, ia, ibc, id, ie) */ * from t3 where a > 10 and b = 20 and c < 35 and d < 45 and e = 100;
explain format = 'brief' select /*+ use_index_merge(t4, ia, ibc, id, ie) */ * from t4 where a > 10 and b = 20 and c < 35 and d in (1,3,8,9) and e = 100;
--sorted_result
select /*+ use_index_merge(t4, ia, ibc, id, ie) */ * from t4 where a > 10 and b = 20 and c < 35 and d in (1,3,8,9) and e = 100;
--disable_warnings

set @@tidb_partition_prune_mode = default;
